<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<dom-module id="graphs-app">
  <template>
    <firebase-app
      name="graphs"
      api-key="AIzaSyC1GizI5R8D7nMzy9jXGAHXTveU4w9IL4A"
      auth-domain="graphs-e23a2.firebaseapp.com"
      database-url="https://graphs-e23a2.firebaseio.com">
    </firebase-app>
    <firebase-auth
      id="auth"
      app-name="graphs"
      provider="google"
      user="{{user}}"
      status-known="{{statusKnown}}">
    </firebase-auth>
    <style>
      :host {
        display: block;
      }

      svg {
				border: 1px solid #888;
        width: 960px;
        height: 500px;
			}

			circle {
				r: 3;
        fill: black;
			}

			path {
	      pointer-events: all;
	      fill: none;
	      stroke: #666;
	      stroke-opacity: 0.2;
	    }

	    .active path {
	      fill: #111;
	      opacity: 0.05;
	    }

			.active text {
	  		visibility: visible;
			}

	    .active circle {
	      stroke: #000;
	      stroke-width: 1.5px;
	    }

      .delete circle {
        fill: red;
        r: 5px;
      }

      .source circle {
        fill: orange;
        r: 5px;
      }

	    .links {
	      stroke: #000;
	      stroke-width: 1.5;
	    }

	    .nodes {
	      stroke-width: 1.5;
	    }

	    text {
	      pointer-events: none;
	      font: 1.8em sans-serif;
	      visibility: hidden;
	    }
    </style>
    <firebase-query
      id="queryNodes"
      app-name="graphs"
      path="/users/[[user.uid]]/nodes"
      data="{{nodes}}">
    </firebase-query>
    <firebase-query
      id="queryLinks"
      app-name="graphs"
      path="/users/[[user.uid]]/links"
      data="{{links}}">
    </firebase-query>
    <svg id="svg" class="svg"></svg>
    <div>
      <paper-button raised on-tap="signin" hidden$="[[user]]">Sign In</paper-button>
      <paper-button raised on-tap="signout" hidden$="[[!user]]">Sign Out</paper-button>
    </div>
  </template>
  <script>
    class GraphsApp extends Polymer.Element {
      static get is() { return 'graphs-app'; }
      static get properties() {
        return {
          nodes: {
            type: Array
          },
          links: {
            type: Array
          }
        };
      }

      static get observers() {
        return [
          '_nodesChanged(nodes.splices)', '_nodesChanged(links.splices)'
        ]
      }

      _nodesChanged(e) {
        if (e) {
          this.node = this.node.data(this.nodes);
          this.node.exit().remove();
          var nodeEnter = this.node.enter()
            .append("g")
            .attr("class", "node")
            .on("mouseover", this.mouseover.bind(e, this))
            .on("mouseout", this.mouseout)
            .on("mousedown", this.mousedown.bind(e, this));
          //  .on("keydown", this.click.bind(e, this));
          nodeEnter.append("circle");
          nodeEnter.append("text")
            .attr("dx", 12)
            .attr("dy", ".35em")
            .text(function(d, i) { return i; });
          nodeEnter.append("path").attr("class", "path");
          nodeEnter.call(d3.drag()
                 .on("start", this.dragstarted.bind(this))
                 .on("drag", this.dragged.bind(this))
                 .on("end", this.dragended.bind(this)));
          this.node = this.node.merge(nodeEnter);

          this.link = this.svg.select(".links").selectAll(".link").data(this.links);
          //this.link = this.link.data(this.links);
          this.link = this.link.enter().append("line")
            .attr("class", "link")
            .merge(this.link);
          this.link.exit().remove();

          this.simulation.nodes(this.nodes);
          this.simulation.force("link").links(this.links);
          this.simulation.alpha(1).restart();
        }

      }

      dblclick() {
        var point = d3.mouse(this);
        this.$.queryNodes.ref.push({
          x: point[0], y: point[1]
        });
      }

      mousedown(graph, node, i, a) {
        console.log(a[i]);
//        setTimeout(graph.delete.bind(a[i]), 3000);
      }

      mouseup(graph, node, i, a) {
        console.log('mouseup');
//        clearTimeout(graph.delete);
      }

      // mouseup(d,i,e) {
      //   setTimeout(function(){
      //     console.log(d,i,e[i]);
      //     d3.select(e[i]).raise().classed("delete", true);
      //   }, 3000);
      // }

      delete() {
        //console.log(this);
        d3.select(this).raise().classed("delete", true);
      }

      click(graph, node) {
        //console.log("keydown", d3.event.keyCode);
        //           debugger;
        // if (!!graph.source && node.hasOwnProperty('$key')) {
        //
        //   var link = {
        //     source: graph.source, target: node
        //   }
        //
        //   //graph.$.queryLinks.ref.push(link);
        //   graph.source = null;
        // } else if (node.hasOwnProperty('$key')) {
        //   graph.source = node;
        // }
      }

      keydown(d) {
        console.log(d3.event);
        if (d3.event.key == "d") {
          d3.select(this.activeNode).raise().classed("active", false);
          d3.select(this.activeNode).raise().classed("delete", true);
          var _node = d3.select(this.activeNode).data()[0].$key;
          var foo = this.$.queryNodes.ref.equalTo(_node);
          console.log(foo);
          // this.$.queryNodes.ref.push({
          //   x: point[0], y: point[1]
          // });
        }

        if (d3.event.key == "l") {
          var _node = d3.select(this.activeNode).data()[0].$key;
          //var foo = this.$.queryNodes.ref.equalTo(_node);
          console.log(_node, this.source);

          if (!!this.source) {
            if (this.source === _node) {
              this.svg.select(".source").raise().classed("source", false);
              this.source = null;
            } else {
              this.target = _node;
              this.$.queryLinks.ref.push({
                source: this.source, target: _node
              });
              this.svg.select(".source").raise().classed("source", false);
              this.target = null;
              this.source = null;
            }
          } else {
              this.source = _node;
              d3.select(this.activeNode).raise().classed("source", true);
          }
        }

        if (d3.event.code == "Space") {
          var point = d3.mouse(this.$.svg);
          console.log(point);
          // this.$.queryNodes.ref.push({
          //   x: point[0], y: point[1]
          // });
        }
      }

      mouseover(graph, node, i, e) {
        //console.log(graph, node, i, e);
        var _node = d3.select(e[i]).raise().classed("active", true);
        graph.activeNode = e[i];
        //console.log(graph.activeNode);
      }

      mouseout(d) {
        d3.select(this).raise().classed("active", false);
      }

      dragstarted(d) {
        if (!d3.event.active) this.simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
      }

      dragged(d) {
        d3.select(this).select("g").attr("cx", d.fx = d3.event.x).attr("cy", d.fy = d3.event.y);
        d.fx = d3.event.x;
        d.fy = d3.event.y;
      }

      dragended(d) {
        if (!d3.event.active) this.simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
      }

      ready() {
        super.ready();
        this.svg = d3.select(this.$.svg).on("dblclick", this.dblclick.bind(this));
        d3.select('body').on("keydown", this.keydown.bind(this));
        this.activeNode;
        this.link = this.svg.append("g").attr("class", "links").selectAll(".link");
        this.node = this.svg.append("g").attr("class", "nodes").selectAll(".node");
        this.simulation = d3.forceSimulation(this.nodes)
          .force("charge", d3.forceManyBody().strength(-10))
          .force("link", d3.forceLink()
                          .id(function(d) { return d.$key; })
                          .distance(100))
          .on("tick", this.ticked.bind(this));

        this.voronoi = d3.voronoi()
          .x(function(d) { return d.x; })
          .y(function(d) { return d.y; })
          .extent([[-1, 1], [960 + 1, 500 + 1]]);

        this.source = null;
        this.null = null;
      }

      ticked() {
        this.node.select("circle")
          .attr("cx", function(d) { return d.x; })
          .attr("cy", function(d) { return d.y; });

        this.node.select("path")
          .data(this.voronoi.polygons(this.node.data()))
          .attr("d", function(d) { return d == null ? null : "M" + d.join("L") + "Z"; });

        this.node.select("text")
          .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")" });


        this.svg.selectAll("line")
          .attr("x1",function(d) { return d.source.x; } )
          .attr("y1", function(d) { return d.source.y; })
          .attr("x2", function(d) { return d.target.x; })
          .attr("y2", function(d) { return d.target.y; });
      }

      signin() {
        return this.$.auth.signInWithPopup();
      }

      signout() {
        return this.$.auth.signOut();
      }
    }

    window.customElements.define(GraphsApp.is, GraphsApp);
  </script>
</dom-module>
