<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<dom-module id="graphs-app">
  <template>
    <firebase-app
      name="graphs"
      api-key="AIzaSyC1GizI5R8D7nMzy9jXGAHXTveU4w9IL4A"
      auth-domain="graphs-e23a2.firebaseapp.com"
      database-url="https://graphs-e23a2.firebaseio.com">
    </firebase-app>
    <firebase-auth
      id="auth"
      app-name="graphs"
      provider="google"
      user="{{user}}"
      status-known="{{statusKnown}}">
    </firebase-auth>
    <style>
      :host {
        display: block;
      }

      svg {
        border: 1px solid #888;
        width: 960px;
        height: 500px;
        pointer-events: all;
      }

      circle {
        r: 3;
      }

      path {
        pointer-events: all;
        fill: none;
        stroke: #666;
        stroke-opacity: 0.2;
      }

      .active path {
        fill: #111;
        opacity: 0.05;
      }
    </style>
    <firebase-query
      id="query"
      app-name="graphs"
      path="/users/[[user.uid]]/nodes"
      data="{{nodes}}">
    </firebase-query>
    <svg id="svg" class="svg"></svg>
    <div>
      <paper-button raised on-tap="signin" hidden$="[[user]]">Sign In</paper-button>
      <paper-button raised on-tap="signout" hidden$="[[!user]]">Sign Out</paper-button>
    </div>
    <ul id="nodes-list">
      <template is="dom-repeat" items="[[nodes]]" as="node">
        <li>[[node.x]], [[node.y]]</li>
      </template>
    </ul>
  </template>
  <script>
    class GraphsApp extends Polymer.Element {
      static get is() { return 'graphs-app'; }
      static get properties() {
        return {
          nodes: {
            type: Array
          }
        };
      }

      static get observers() {
        return [
          '_nodesChanged(nodes.splices)'
        ]
      }

      _nodesChanged(e) {
        if (e) {
          this.node = this.node.data(this.nodes);
          this.node.exit().remove();
          var nodeEnter = this.node.enter()
            .append("g")
            .attr("class", "node");
          nodeEnter.append("circle")
            .attr("fill", "black");
          nodeEnter.append("path").attr("class", "path");
          nodeEnter.call(d3.drag()
                 .on("start", this.dragstarted.bind(this))
                 .on("drag", this.dragged.bind(this))
                 .on("end", this.dragended.bind(this)));
          this.node = this.node.merge(nodeEnter);

          this.simulation.nodes(this.nodes);
          //this.simulation.force("link").links(links);
          this.simulation.alpha(1).restart();
        }

      }

      dblclick() {
        var point = d3.mouse(this);
        this.$.query.ref.push({
          x: point[0], y: point[1]
        });
      }

      dragstarted(d) {
        //d3.select(this).raise().classed("active", true);
        if (!d3.event.active) this.simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
      }

      dragged(d) {
        d3.select(this).select("g").attr("cx", d.fx = d3.event.x).attr("cy", d.fy = d3.event.y);
        d.fx = d3.event.x;
        d.fy = d3.event.y;
      }

      dragended(d) {
        //d3.select(this).classed("active", false);
        if (!d3.event.active) this.simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
      }

      ready() {
        super.ready();
        this.svg = d3.select(this.$.svg).on("dblclick", this.dblclick.bind(this));
        var width = +this.svg.attr("width");
        var height = +this.svg.attr("height");
        this.node = this.svg.append("g").attr("class", "nodes").selectAll(".node");
        this.simulation = d3.forceSimulation(this.nodes)
          .force("charge", d3.forceManyBody().strength(-10))
          .force("link", d3.forceLink()
                          .id(function(d) { return d.__firebaseKey__; })
                          .distance(100))
          .on("tick", this.ticked.bind(this));

        this.voronoi = d3.voronoi()
          .x(function(d) { return d.x; })
          .y(function(d) { return d.y; })
          .extent([[-1, 1], [960 + 1, 500 + 1]]);
      }

      ticked() {
        this.node.select("circle")
          .attr("cx", function(d) { return d.x; })
          .attr("cy", function(d) { return d.y; });

          var data = this.node.data();
          this.node.select("path")
            .data(this.voronoi.polygons(data))
            .attr("d", function(d) { return d == null ? null : "M" + d.join("L") + "Z"; });



        // node.select("path")
        //   .data(voronoi.polygons(node.data()))
        //   .attr("d", function(d) { return d == null ? null : "M" + d.join("L") + "Z"; });
        //
        // node.select("text")
        //   .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")" });
        //
        // svg.selectAll(".link")
        //   .attr("x1",function(d) { return d.source.x; } )
        //   .attr("y1", function(d) { return d.source.y; })
        //   .attr("x2", function(d) { return d.target.x; })
        //   .attr("y2", function(d) { return d.target.y; });

      }

      signin() {
        return this.$.auth.signInWithPopup();
      }

      signout() {
        return this.$.auth.signOut();
      }
    }

    window.customElements.define(GraphsApp.is, GraphsApp);
  </script>
</dom-module>
